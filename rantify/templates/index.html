{% extends "layout.html" %}

{% block navbar %}
    <a class="ms-auto">
        <img src="{{ user.image_url if user.image_url else '../static/images/default-user.png' }}" class="rounded-circle d-inline-block align-text-top" width="48" height="48" alt="User image">
        <a href="/logout" style="color: white;">Log out</a>
    </a>
{% endblock %}

{% block main %}


<section id="main">

    <div class="container-fluid d-flex justify-content-center text-center p-5 flex-column">
        <div class="row pb-3 pb-lg-5">
            <h1 class="display-1 fw-bold">Rantify</h1>
        </div>
        <div class="row justify-content-center column-gap-5">
            <div class="col-lg-5 g-4 pe-3">
                <div class="card rant-card rounded-4 h-auto">
                    <div class="card-body">
                        <h3 class="card-title pb-3">Rant my</h3>
                        <form id="rant-form" class="col-12 col-lg-10 d-grid mx-auto pb-2" onsubmit="return false;">
                            <select id="playlist-select" name="playlist" required class="form-select mb-3">
                                <option disabled selected value="">Playlist</option>
                                {% for playlist in playlists %}
                                    <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                                {% endfor %}
                            </select>
                            <div id="rant-buttons">
                                <button id="rant-button" class="btn btn-lg btn-green rounded-5">Rate</button>
                            </div>
                        </form>
                        <div id="rant-error" class="text-danger">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 g-4 pe-3">
                <div class="card rant-card rounded-4 h-100">
                    <div class="card-body d-flex flex-column h-100">
                        <h3 class="card-title pb-3">Result</h3>
                        <div id="rant-display" class="d-flex flex-column mx-auto flex-grow-1 pb-2 px-3">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<script>

    // Runs after DOM is fully loaded.
    $(document).ready(
        function() {
            onRantButtonClicked();
        }
    );


    // Runs when Rant Button is clicked
    function onRantButtonClicked() {
        $("#rant-button").click(function(eventObject) {

            if (!$("#playlist-select").val()) {
                displayRantError("You must select a playlist.");
                return;
            }

            var $button = $(this);
            $button.prop("disabled", true);

            // Submits the rant data via jQuery AJAX.
            $.ajax({
                url: "/rant",
                method: "POST",
                data: $("#rant-form").serialize(),
                beforeSend: function() {
                    displayLoadingDots();
                },
                success: (data, textStatus, jqXHR) => {
                    removeLoadingDots();
                    displayRant(data);
                    $button.prop("disabled", false);
                },
                error: (jqXHR, textStatus, errorThrown) => {
                    removeLoadingDots();
                    displayRantError("Failed to submit rant. Please try again.");
                    $button.prop("disabled", false);
                },
            });
        });
    }


    // Displays the rant in index page via jQuery.
    function displayRant(rantContent) {
        $("#rant-display").html(rantContent);
        removeRantError();
    }


    // Displays the rant errpr in index page via jQuery.
    function displayRantError(errorMessage) {
        $("#rant-error").html(errorMessage);
        $("#rant-display").empty();
    }


    // Removes the rant errpr in index page via jQuery.
    function removeRantError() {
        $("#rant-error").empty();
    }



    // Displays the loading dots in index page via jQuery.
    function displayLoadingDots() {
        $("#rant-display").html("<div class='d-flex justify-content-center align-items-center h-100'><div class='loading-dots'></div></div>");
    }

    
    // Removes the loading dots in index page via jQuery.
    function removeLoadingDots() {
        $(".loading-dots").remove();
    }

</script>

{% endblock %}