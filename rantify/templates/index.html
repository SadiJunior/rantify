{% extends "layout.html" %}

{% block navbar %}
    <a class="ms-auto">
        <img src="{{ user.image_url if user.image_url else '../static/images/default-user.png' }}" class="rounded-circle d-inline-block align-text-top" width="48" height="48" alt="User image">
        <a href="/logout" style="color: white;">Log out</a>
    </a>
{% endblock %}

{% block main %}


<section id="main">

    <div class="container-fluid d-flex justify-content-center text-center p-4 p-lg-5 flex-column">
        <div class="row pb-3 pb-lg-5">
            <h1 class="display-1 fw-bold">Rantify</h1>
        </div>
        <div class="row justify-content-center column-gap-5">
            <div class="col-lg-5 g-4 pe-3">
                <div class="card rant-card rounded-4 h-auto">
                    <div class="card-body">
                        <h3 class="card-title pb-3">Rant my</h3>
                        <form id="rant-form" class="col-12 col-lg-10 d-grid mx-auto pb-2" onsubmit="return false;">
                            <select id="playlist-select" name="playlist" required class="form-select mb-3">
                                <option disabled selected value="">Playlist</option>
                                {% for playlist in playlists %}
                                    <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                                {% endfor %}
                            </select>
                            <div id="rant-buttons" class="d-flex justify-content-center">
                                <button id="rate-button" class="rant-button btn btn-lg btn-green rounded-5 flex-grow-1 mx-1 mx-lg-2">Rate</button>
                                <button id="roast-button" class="rant-button btn btn-lg btn-red rounded-5 flex-grow-1 mx-1 mx-lg-2">Roast</button>
                                <button id="rhyme-button" class="rant-button btn btn-lg btn-blue rounded-5 flex-grow-1 mx-1 mx-lg-2">Rhyme</button>
                            </div>
                        </form>
                        <div id="rant-error" class="text-danger">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 g-4 pe-3">
                <div class="card rant-card rounded-4 h-100">
                    <div class="card-body d-flex flex-column h-100">
                        <h3 class="card-title pb-3">Result</h3>
                        <div id="rant-display" class="d-flex flex-column mx-auto flex-grow-1 pb-2 px-lg-3">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<script>

    // Runs after DOM is fully loaded.
    $(document).ready(
        function() {
            onRateButtonClicked();
            onRoastButtonClicked();
            onRhymeButtonClicked();
        }
    );


    // Runs when Rate Button is clicked
    function onRateButtonClicked() {
        onRantButtonClicked("#rate-button", "/rate");
    }


    // Runs when Rate Button is clicked
    function onRoastButtonClicked() {
        onRantButtonClicked("#roast-button", "/roast");
    }


    // Runs when Rhyme Button is clicked
    function onRhymeButtonClicked() {
        onRantButtonClicked("#rhyme-button", "/rhyme");
    }


    // Runs when Rant Button is clicked
    function onRantButtonClicked(buttonId, url) {
        $(buttonId).click(function(eventObject) {

            if (!$("#playlist-select").val()) {
                displayRantError("You must select a playlist.");
                return;
            }

            disableRantButtons();

            // Submits the rant data via jQuery AJAX.
            $.ajax({
                url: url,
                method: "POST",
                data: $("#rant-form").serialize(),
                beforeSend: function() {
                    displayLoadingDots();
                },
                success: (data, textStatus, jqXHR) => {
                    removeLoadingDots();
                    displayRant(data);
                    enableRantButtons();
                },
                error: (jqXHR, textStatus, errorThrown) => {
                    removeLoadingDots();
                    displayRantError("Failed to submit rant. Please try again.");
                    enableRantButtons();
                },
                statusCode: {
                    401: () => {
                        redirect("/login");
                    }
                }
            });
        });
    }

    // Displays the rant in index page via jQuery.
    function displayRant(rantContent) {
        $("#rant-display").html(rantContent);
        removeRantError();
    }


    // Displays the rant errpr in index page via jQuery.
    function displayRantError(errorMessage) {
        $("#rant-error").html(errorMessage);
        $("#rant-display").empty();
    }


    // Removes the rant errpr in index page via jQuery.
    function removeRantError() {
        $("#rant-error").empty();
    }


    // Disables all rant buttons via jQuery.
    function disableRantButtons() {
        $(".rant-button").prop("disabled", true);
    }

    // Enables all rant buttons via jQuery.
    function enableRantButtons() {
        $(".rant-button").prop("disabled", false);
    }


    // Displays the loading dots in index page via jQuery.
    function displayLoadingDots() {
        const loadingDotsHtml = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="loading-dots"></div>
            </div>
        `;

        $("#rant-display").html(loadingDotsHtml);
    }

    
    // Removes the loading dots in index page via jQuery.
    function removeLoadingDots() {
        $(".loading-dots").remove();
    }


    // Redirects to the given URL.
    function redirect(url) {
        window.location.href = url;
    }

</script>

{% endblock %}